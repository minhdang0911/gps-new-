'use client';

import React, { useState, useEffect, useRef, useMemo } from 'react';
import './MonitorPage.css';

import { getDevices, getDeviceInfo, lockDevice, unlockDevice } from './lib/api/devices';
import { getBatteryStatusByImei } from './lib/api/batteryStatus';
import { getLastCruise } from './lib/api/cruise';

import markerIcon from './assets/marker-red.png';
import { useRouter } from 'next/navigation';
import { message, Modal } from 'antd';
import { CheckCircleFilled, LockFilled } from '@ant-design/icons';

// üî• MQTT
import MqttConnector from './components/MqttConnector';

const { confirm } = Modal;
const GOONG_API_KEY = process.env.NEXT_PUBLIC_GOONG_API_KEY;

const toLocalDateTimeInput = (date) => {
    const pad = (n) => String(n).padStart(2, '0');
    const year = date.getFullYear();
    const month = pad(date.getMonth() + 1);
    const day = pad(date.getDate());
    const hours = pad(date.getHours());
    const minutes = pad(date.getMinutes());
    return `${year}-${month}-${day}T${hours}:${minutes}`;
};

const MonitorPage = () => {
    const [leftTab, setLeftTab] = useState('monitor');
    const [showPopup, setShowPopup] = useState(false);
    const [detailTab, setDetailTab] = useState('status');
    const [LMap, setLMap] = useState(null);

    const [historyDeviceId, setHistoryDeviceId] = useState('');
    const [historyStart, setHistoryStart] = useState('');
    const [historyEnd, setHistoryEnd] = useState('');
    const [historyMessage, setHistoryMessage] = useState('');
    const [historyMessageType, setHistoryMessageType] = useState('');

    const [deviceList, setDeviceList] = useState([]);
    const [loadingDevices, setLoadingDevices] = useState(false);

    const [searchText, setSearchText] = useState('');
    const [statusFilter, setStatusFilter] = useState('all');

    const [selectedDevice, setSelectedDevice] = useState(null);

    const [batteryStatus, setBatteryStatus] = useState(null);
    const [loadingBattery, setLoadingBattery] = useState(false);

    const [deviceInfo, setDeviceInfo] = useState(null);
    const [loadingDeviceInfo, setLoadingDeviceInfo] = useState(false);

    const [lastCruise, setLastCruise] = useState(null);
    const [loadingCruise, setLoadingCruise] = useState(false);
    const [cruiseError, setCruiseError] = useState(null);

    const [lockLoading, setLockLoading] = useState(false);
    const [lockError, setLockError] = useState(null);

    const [address, setAddress] = useState('');
    const [addressOld, setAddressOld] = useState(''); // üî• ƒë·ªãa ch·ªâ tr∆∞·ªõc s√°p nh·∫≠p
    const [loadingAddress, setLoadingAddress] = useState(false);
    const [addressError, setAddressError] = useState(null);

    const [lat] = useState(10.7542506);
    const [lng] = useState(106.6170202);

    // üî• d·ªØ li·ªáu realtime t·ª´ MQTT
    const [liveTelemetry, setLiveTelemetry] = useState(null);
    const mqttClientRef = useRef(null);

    useEffect(() => {
        const loadLeaflet = async () => {
            const L = await import('leaflet');
            await import('leaflet/dist/leaflet.css');
            setLMap(L);
        };
        loadLeaflet();
    }, []);

    const mapRef = useRef(null);
    const markerRef = useRef(null);
    const [markerScreenPos, setMarkerScreenPos] = useState(null);
    const router = useRouter();

    useEffect(() => {
        if (!LMap) return;

        const map = LMap.map('iky-map', {
            center: [lat, lng],
            zoom: 16,
            zoomControl: false,
            attributionControl: false,
            dragging: true,
            scrollWheelZoom: true,
        });

        mapRef.current = map;

        LMap.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        const customIcon = LMap.icon({
            iconUrl: markerIcon.src,
            iconSize: [36, 36],
            iconAnchor: [18, 36],
        });

        const marker = LMap.marker([lat, lng], { icon: customIcon }).addTo(map);
        markerRef.current = marker;

        const updatePopupPosition = () => {
            const point = map.latLngToContainerPoint(marker.getLatLng());
            setMarkerScreenPos(point);
        };

        updatePopupPosition();

        marker.on('click', () => {
            setShowPopup(true);
        });

        map.on('click', () => {
            setShowPopup(false);
        });

        map.on('move zoom', updatePopupPosition);

        const handleResize = () => {
            map.invalidateSize();
            updatePopupPosition();
        };
        window.addEventListener('resize', handleResize);

        return () => {
            window.removeEventListener('resize', handleResize);
            map.off('move', updatePopupPosition);
            map.off('zoom', updatePopupPosition);
            map.remove();
        };
    }, [LMap, lat, lng]);

    useEffect(() => {
        const token = localStorage.getItem('accessToken');
        if (!token) return;

        const fetchDevices = async () => {
            try {
                setLoadingDevices(true);
                const res = await getDevices(token, { limit: 50 });
                setDeviceList(res.devices || []);
            } catch (err) {
                console.error('Load devices error:', err);
            } finally {
                setLoadingDevices(false);
            }
        };

        fetchDevices();
    }, []);

    // =============================
    // üî• PARSE TIM (YYMMDDHHmmSS)
    // =============================
    const parseTimToDate = (tim) => {
        if (!tim) return null;

        const s = String(tim);
        if (s.length !== 12) return null;

        const yy = s.slice(0, 2);
        const MM = s.slice(2, 4);
        const dd = s.slice(4, 6);
        const hh = s.slice(6, 8);
        const mm = s.slice(8, 10);
        const ss = s.slice(10, 12);

        const yyyy = 2000 + Number(yy);

        const date = new Date(`${yyyy}-${MM}-${dd}T${hh}:${mm}:${ss}`);

        if (isNaN(date.getTime())) return null;
        return date;
    };

    useEffect(() => {
        if (deviceList.length > 0 && !selectedDevice) {
            handleSelectDevice(deviceList[0]);
        }
    }, [deviceList]);

    useEffect(() => {
        if (typeof window === 'undefined') return;
        if (!deviceList.length) return;

        if (!historyDeviceId && deviceList[0]) {
            setHistoryDeviceId(deviceList[0]._id);
        }

        if (!historyStart || !historyEnd) {
            const now = new Date();

            const start = new Date(now);
            start.setHours(0, 0, 0, 0);

            const end = new Date(now);
            end.setHours(23, 59, 0, 0);

            setHistoryStart(toLocalDateTimeInput(start));
            setHistoryEnd(toLocalDateTimeInput(end));
        }
    }, [deviceList]);

    const fetchAddressFromGoong = async (latVal, lonVal) => {
        if (latVal == null || lonVal == null) return;

        setLoadingAddress(true);
        setAddressError(null);

        const lat = Number(latVal);
        const lon = Number(lonVal);

        const tryGoongV2 = async () => {
            if (!GOONG_API_KEY) return null;

            const url = `https://rsapi.goong.io/v2/geocode/street?api_key=${GOONG_API_KEY}&latlng=${lat},${lon}&has_deprecated_administrative_unit=true`;

            const res = await fetch(url);

            if (!res.ok) throw new Error('Goong V2 API error');

            const json = await res.json();
            const first = json?.results?.[0];
            if (!first) return null;

            // ƒë·ªãa ch·ªâ hi·ªán t·∫°i
            const addr = first.formatted_address || first.address || first.name || '';

            // ƒë·ªãa ch·ªâ tr∆∞·ªõc s√°p nh·∫≠p
            const oldAddr =
                first.deprecated_description ||
                (() => {
                    const c = first.deprecated_compound;
                    if (!c) return '';
                    return [c.commune, c.district, c.province].filter(Boolean).join(', ');
                })();

            return { addr, oldAddr };
        };

        // fallback OSM gi·ªØ nguy√™n
        const tryNominatim = async () => {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('Nominatim error');
            const data = await res.json();
            return { addr: data?.display_name || '', oldAddr: '' };
        };

        try {
            let addr = '';
            let oldAddr = '';

            // th·ª≠ Goong m·ªõi tr∆∞·ªõc
            try {
                const data = await tryGoongV2();
                if (data?.addr) {
                    addr = data.addr;
                    oldAddr = data.oldAddr;
                }
            } catch (e) {
                console.error('Goong V2 kh√¥ng ch·∫°y, th·ª≠ OSM:', e);
            }

            if (!addr) {
                // fallback
                try {
                    const data2 = await tryNominatim();
                    addr = data2.addr;
                    oldAddr = '';
                } catch (e2) {
                    console.error('Nominatim fail:', e2);
                }
            }

            if (addr) {
                setAddress(addr);
                setAddressOld(oldAddr || '');
            } else {
                setAddress('');
                setAddressOld('');
                setAddressError('Kh√¥ng l·∫•y ƒë∆∞·ª£c ƒë·ªãa ch·ªâ.');
            }
        } catch (err) {
            console.error('Address fetch error:', err);
            setAddress('');
            setAddressOld('');
            setAddressError('Kh√¥ng l·∫•y ƒë∆∞·ª£c ƒë·ªãa ch·ªâ.');
        } finally {
            setLoadingAddress(false);
        }
    };

    const publishControlCommand = (payload) => {
        if (!selectedDevice || !selectedDevice.imei) {
            const msgText = 'Ch∆∞a ch·ªçn thi·∫øt b·ªã ho·∫∑c thi·∫øu IMEI.';
            setLockError(msgText);
            message.error(msgText);
            return;
        }

        const client = mqttClientRef.current;
        if (!client) {
            const msgText = 'Ch∆∞a k·∫øt n·ªëi MQTT ƒë·∫øn thi·∫øt b·ªã.';
            setLockError(msgText);
            message.error(msgText);
            return;
        }

        const topic = `device/${selectedDevice.imei}/control`;

        try {
            client.publish(topic, JSON.stringify(payload), { qos: 1 }, (err) => {
                if (err) {
                    console.error('‚ùå Publish control error:', err);
                    const msgText = 'G·ª≠i l·ªánh ƒëi·ªÅu khi·ªÉn th·∫•t b·∫°i.';
                    setLockError(msgText);
                    message.error(msgText);
                } else {
                    console.log('üì§ ƒê√£ g·ª≠i l·ªánh control:', topic, payload);
                    setLockError(null);
                }
            });
        } catch (e) {
            console.error('‚ùå Publish exception:', e);
            const msgText = 'G·ª≠i l·ªánh ƒëi·ªÅu khi·ªÉn l·ªói.';
            setLockError(msgText);
            message.error(msgText);
        }
    };

    const filteredDevices = useMemo(() => {
        const keyword = searchText.trim().toLowerCase();

        return deviceList.filter((d) => {
            const plate = (d.license_plate || '').toLowerCase();
            const imei = (d.imei || '').toLowerCase();
            const phone = (d.phone_number || '').toLowerCase();

            const matchSearch =
                !keyword || plate.includes(keyword) || imei.includes(keyword) || phone.includes(keyword);

            const isOnline = d.status === 10;
            let matchStatus = true;
            if (statusFilter === 'online') matchStatus = isOnline;
            if (statusFilter === 'offline') matchStatus = !isOnline;

            return matchSearch && matchStatus;
        });
    }, [deviceList, searchText, statusFilter]);

    const handleSelectDevice = async (device) => {
        setSelectedDevice(device);
        setShowPopup(true);

        // reset MQTT data khi ƒë·ªïi xe
        setLiveTelemetry(null);

        const token = localStorage.getItem('accessToken');
        if (!token || !device?.imei) {
            setBatteryStatus(null);
            setDeviceInfo(null);
            setLastCruise(null);
            setCruiseError('Thi·∫øu token ho·∫∑c IMEI ƒë·ªÉ t·∫£i d·ªØ li·ªáu');
            return;
        }

        setBatteryStatus(null);
        setDeviceInfo(null);
        setLastCruise(null);
        setCruiseError(null);
        setAddress('');
        setAddressOld(''); // üî• reset ƒë·ªãa ch·ªâ c≈©
        setAddressError(null);

        try {
            setLoadingBattery(true);
            const res = await getBatteryStatusByImei(token, device.imei);
            setBatteryStatus(res?.batteryStatus || null);
        } catch {
            setBatteryStatus(null);
        } finally {
            setLoadingBattery(false);
        }

        try {
            setLoadingDeviceInfo(true);
            const info = await getDeviceInfo(token, device._id);
            setDeviceInfo(info || null);
        } catch {
            setDeviceInfo(null);
        } finally {
            setLoadingDeviceInfo(false);
        }

        try {
            setLoadingCruise(true);
            const cruise = await getLastCruise(token, device.imei);

            if (!cruise || cruise.error) {
                setLastCruise(null);
                setCruiseError('Kh√¥ng c√≥ d·ªØ li·ªáu h√†nh tr√¨nh');
            } else {
                setLastCruise(cruise);
                setCruiseError(null);

                if (mapRef.current && markerRef.current && cruise.lat && cruise.lon) {
                    const newLatLng = LMap.latLng(cruise.lat, cruise.lon);
                    markerRef.current.setLatLng(newLatLng);
                    mapRef.current.setView(newLatLng, 16);
                }

                if (cruise.lat != null && cruise.lon != null) {
                    fetchAddressFromGoong(cruise.lat, cruise.lon);
                }
            }
        } catch {
            setLastCruise(null);
            setCruiseError('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu h√†nh tr√¨nh');
        } finally {
            setLoadingCruise(false);
        }
    };

    const handleLockDevice = () => {
        // kho√° = b·∫≠t SOS
        publishControlCommand({ sos: 1 });
        message.success('ƒê√£ g·ª≠i l·ªánh kho√° thi·∫øt b·ªã (SOS b·∫≠t).');
    };

    const handleUnlockDevice = () => {
        // m·ªü kho√° = t·∫Øt SOS
        publishControlCommand({ sos: 0 });
        message.success('ƒê√£ g·ª≠i l·ªánh m·ªü kho√° thi·∫øt b·ªã (SOS t·∫Øt).');
    };

    const handleConfirmLock = () => {
        if (!selectedDevice) return;
        const plate = selectedDevice.license_plate || selectedDevice.imei || 'thi·∫øt b·ªã';

        confirm({
            title: 'X√°c nh·∫≠n kho√° thi·∫øt b·ªã',
            content: `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën kho√° ${plate}?`,
            okText: 'Kho√°',
            cancelText: 'Hu·ª∑',
            onOk: () => handleLockDevice(),
        });
    };

    const handleConfirmUnlock = () => {
        if (!selectedDevice) return;
        const plate = selectedDevice.license_plate || selectedDevice.imei || 'thi·∫øt b·ªã';

        confirm({
            title: 'X√°c nh·∫≠n m·ªü kho√° thi·∫øt b·ªã',
            content: `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën m·ªü kho√° ${plate}?`,
            okText: 'M·ªü kho√°',
            cancelText: 'Hu·ª∑',
            onOk: () => handleUnlockDevice(),
        });
    };

    const isLocked = Number(liveTelemetry?.sos) === 1;

    const isConnected = selectedDevice?.status === 10; // c√°i n√†y v·∫´n theo backend n·∫øu m mu·ªën

    // helper normalize number
    const toNumberOrNull = (val) => {
        if (val == null) return null;
        const n = Number(val);
        return Number.isNaN(n) ? null : n;
    };

    // parse d√≤ng s·∫°c/x·∫£ c≈© (kh√¥ng d√πng n·ªØa nh∆∞ng ƒë·ªÉ ƒë√¢y c≈©ng kh√¥ng sao)
    const parseCurrentValue = (currentRaw) => {
        if (currentRaw == null) return { text: 'D√≤ng s·∫°c/x·∫£: --' };

        const num = Number(String(currentRaw).replace(',', '.'));
        if (Number.isNaN(num)) return { text: 'D√≤ng s·∫°c/x·∫£: --' };

        if (num > 0) {
            return { text: `D√≤ng s·∫°c/x·∫£: ƒêang s·∫°c ${num}A` };
        }

        if (num < 0) {
            return { text: `D√≤ng s·∫°c/x·∫£: ƒêang x·∫£ ${Math.abs(num)}A` };
        }

        return { text: `D√≤ng s·∫°c/x·∫£: 0 A` };
    };

    // üî• nh·∫≠n MQTT ‚Üí update liveTelemetry + map
    const handleMqttMessage = (topic, data) => {
        if (!selectedDevice) return;

        const arr = topic.split('/');
        if (arr[1] !== selectedDevice.imei) return;

        if (!data || typeof data !== 'object') return;

        // merge
        setLiveTelemetry((prev) => ({ ...(prev || {}), ...data }));

        // realtime map move
        if (data.lat != null && data.lon != null && LMap && mapRef.current && markerRef.current) {
            const pos = LMap.latLng(data.lat, data.lon);
            markerRef.current.setLatLng(pos);
            mapRef.current.setView(pos, 16);
            fetchAddressFromGoong(data.lat, data.lon);
        }
    };

    const DEVICE_FIELDS = [
        'tim',
        'lat',
        'lon',
        'spd',
        'dst',
        'gps',
        'sos',
        'acc',
        'mov',
        'alm',
        'pro',
        'vib',
        'mil',
        'gic',
        'onl',
        'fwr',
        'vgp',
    ];

    const BATTERY_FIELDS = ['soc', 'soh', 'tavg', 'tmax', 'tmin', 'vavg', 'vmax', 'vmin', 'cur', 'ckw', 'ckwh', 'an1'];

    // üîã d√πng MQTT override batteryStatus
    const renderBatteryInfo = () => {
        const src = liveTelemetry || {};
        const bs = batteryStatus || {};

        const soc = src.soc ?? bs.soc;
        const soh = src.soh ?? bs.soh;
        const voltage = src.vavg ?? src.vmax ?? src.vmin ?? bs.voltage;
        const temp = src.tavg ?? src.tmax ?? bs.temperature;
        const currentRaw = src.cur ?? bs.current;

        const formatAmp = (val) => {
            const n = toNumberOrNull(val);
            if (n == null) return '--';
            const abs = Math.abs(n);
            const s = abs.toFixed(2).replace('.', ',');
            return `${s}A`;
        };

        let mode = 'Kh√¥ng x√°c ƒë·ªãnh';
        let currentLine = 'D√≤ng s·∫°c/x·∫£: --';

        const cur = toNumberOrNull(currentRaw);

        if (cur == null) {
            mode = 'Kh√¥ng x√°c ƒë·ªãnh';
            currentLine = 'D√≤ng s·∫°c/x·∫£: --';
        } else if (cur > 0) {
            mode = 'ƒêang s·∫°c';
            currentLine = `D√≤ng s·∫°c: ${formatAmp(cur)}`;
        } else if (cur < 0) {
            mode = 'ƒêang x·∫£';
            currentLine = `D√≤ng x·∫£: ${formatAmp(cur)}`;
        } else {
            mode = 'ƒêang ch·ªù';
            currentLine = 'D√≤ng s·∫°c/x·∫£: ƒêang ch·ªù';
        }

        const updatedAt = src.tim
            ? parseTimToDate(src.tim)?.toLocaleString()
            : bs.updatedAt
            ? new Date(bs.updatedAt).toLocaleString()
            : '--';

        return (
            <>
                <div>IMEI: {selectedDevice?.imei}</div>
                <div>ƒêi·ªán √°p: {voltage ?? '--'} V</div>
                <div>{currentLine}</div>
                <div>Tr·∫°ng th√°i: {mode}</div>
                <div>Tr·∫°ng th√°i s·∫°c (SOC): {soc ?? '--'}%</div>
                <div>S·ª©c kh·ªèe pin (SOH): {soh ?? '--'}%</div>
                <div>Nhi·ªát ƒë·ªô: {temp ?? '--'}¬∞C</div>
                <div>C·∫≠p nh·∫≠t l√∫c: {updatedAt}</div>
            </>
        );
    };

    const renderStatusInfo = () => {
        if (!selectedDevice) return <>Vui l√≤ng ch·ªçn xe.</>;

        const info = deviceInfo || selectedDevice;
        const src = liveTelemetry || lastCruise || {};
        const mqttSrc = liveTelemetry || {};

        const speed = mqttSrc.spd;
        const distance = mqttSrc.dst;

        const timeStr = src.tim ? parseTimToDate(src.tim)?.toLocaleString() : '--';

        const latVal = src.lat;
        const lonVal = src.lon;

        const accValNum = toNumberOrNull(mqttSrc.acc);
        const spdNum = toNumberOrNull(mqttSrc.spd);
        const vgpNum = toNumberOrNull(mqttSrc.vgp);

        let machineStatus = '--';
        if (accValNum === 1) {
            machineStatus = 'T·∫Øt m√°y';
        } else {
            machineStatus = 'M·ªü m√°y';
        }

        let vehicleStatus = '--';

        if (accValNum === 1) {
            vehicleStatus = 'ƒê·ªó xe';
        } else {
            let usedSpeed = null;
            if (spdNum != null) {
                usedSpeed = spdNum;
            } else if (vgpNum != null) {
                usedSpeed = vgpNum;
            }

            if (usedSpeed == null) {
                vehicleStatus = 'ƒê·ªó xe';
            } else if (usedSpeed > 0) {
                vehicleStatus = `ƒêang ch·∫°y ${usedSpeed} km/h`;
            } else {
                vehicleStatus = 'ƒê·ªó xe';
            }
        }

        const extra = liveTelemetry
            ? Object.entries(liveTelemetry).filter(
                  ([k, v]) => v != null && !BATTERY_FIELDS.includes(k) && !DEVICE_FIELDS.includes(k),
              )
            : [];

        return (
            <>
                <div>Bi·ªÉn s·ªë xe: {info.license_plate || '---'}</div>
                <div>Lo·∫°i xe: {info.vehicle_category_id?.name || '---'}</div>
                <div>D√≤ng thi·∫øt b·ªã: {info.device_category_id?.name || '---'}</div>
                <div>T·∫°i th·ªùi ƒëi·ªÉm: {timeStr}</div>

                <div>Tr·∫°ng th√°i m√°y: {machineStatus}</div>
                <div>Tr·∫°ng th√°i xe: {vehicleStatus}</div>

                {speed != null && <div>T·ªëc ƒë·ªô : {speed} km/h</div>}
                {distance != null && <div>Qu√£ng ƒë∆∞·ªùng: {distance} km</div>}

                <div>V·ªã tr√≠ (hi·ªán t·∫°i): {address || '--'}</div>
                {addressOld && <div>V·ªã tr√≠ (tr∆∞·ªõc s√°p nh·∫≠p): {addressOld}</div>}
                <div>T·ªça ƒë·ªô: {latVal && lonVal ? `${latVal}, ${lonVal}` : '--'}</div>

                {/* <div>ƒê·ªãa ch·ªâ: {address || '--'}</div> */}

                {/* d·ªØ li·ªáu kh√°c t·ª´ mqtt t·∫°m cmt l·∫°i sau n√†y hi·ªÉn th·ªã sau ch·ª© kh√¥ng b·ªè */}

                {/* {extra.length > 0 && (
                    <div style={{ marginTop: 10 }}>
                        <b>D·ªØ li·ªáu kh√°c:</b>
                        {extra.map(([k, v]) => (
                            <div key={k}>
                                {k}: {String(v)}
                            </div>
                        ))}
                    </div>
                )} */}
            </>
        );
    };

    const handleSaveHistoryFilter = () => {
        setHistoryMessage('');
        setHistoryMessageType('');

        if (!historyDeviceId || !historyStart || !historyEnd) {
            setHistoryMessage('Vui l√≤ng ch·ªçn xe v√† nh·∫≠p ƒë·∫ßy ƒë·ªß "T·ª´ ng√†y" / "ƒê·∫øn ng√†y".');
            setHistoryMessageType('error');
            return;
        }

        const startDate = new Date(historyStart);
        const endDate = new Date(historyEnd);

        if (Number.isNaN(startDate.getTime()) || Number.isNaN(endDate.getTime())) {
            setHistoryMessage('ƒê·ªãnh d·∫°ng th·ªùi gian kh√¥ng h·ª£p l·ªá. Vui l√≤ng ch·ªçn l·∫°i.');
            setHistoryMessageType('error');
            return;
        }

        if (endDate < startDate) {
            setHistoryMessage('Th·ªùi gian "ƒê·∫øn ng√†y" kh√¥ng ƒë∆∞·ª£c nh·ªè h∆°n "T·ª´ ng√†y".');
            setHistoryMessageType('error');
            return;
        }

        const filter = {
            deviceId: historyDeviceId,
            imei: deviceList.find((d) => d._id === historyDeviceId)?.imei || '',
            start: historyStart,
            end: historyEnd,
        };
        try {
            localStorage.setItem('iky_cruise_filter', JSON.stringify(filter));
            router.push('/cruise');
            setHistoryMessage('ƒê√£ l∆∞u b·ªô l·ªçc l·ªô tr√¨nh. V√†o trang "H√†nh tr√¨nh" ƒë·ªÉ t·∫£i l·ªô tr√¨nh.');
            setHistoryMessageType('success');
        } catch (e) {
            setHistoryMessage('Kh√¥ng th·ªÉ l∆∞u b·ªô l·ªçc. Vui l√≤ng th·ª≠ l·∫°i.');
            setHistoryMessageType('error');
        }
    };

    const STATUS_MAP = {
        5: { text: 'ƒê√£ kho√°', class: 'iky-monitor__tag-red' },
        10: { text: 'ƒêang ho·∫°t ƒë·ªông', class: 'iky-monitor__tag-green' },
    };

    const curStatus = selectedDevice?.status;
    const deviceStatusText = isLocked ? 'ƒê√£ kho√°' : 'ƒêang ho·∫°t ƒë·ªông';
    const deviceStatusClass = isLocked ? 'iky-monitor__tag-red' : 'iky-monitor__tag-green';

    return (
        <>
            {/* MQTT realtime cho xe ƒëang ch·ªçn */}
            <MqttConnector
                imei={selectedDevice?.imei}
                onMessage={handleMqttMessage}
                onClientReady={(client) => {
                    mqttClientRef.current = client;
                }}
            />

            <div className="iky-monitor">
                {/* LEFT */}
                <aside className="iky-monitor__left">
                    <div className="iky-monitor__left-card">
                        <div className="iky-monitor__left-tabs">
                            <button
                                className={
                                    'iky-monitor__left-tab' +
                                    (leftTab === 'monitor' ? ' iky-monitor__left-tab--active' : '')
                                }
                                onClick={() => setLeftTab('monitor')}
                            >
                                Gi√°m s√°t xe
                            </button>
                            <button
                                className={
                                    'iky-monitor__left-tab' +
                                    (leftTab === 'history' ? ' iky-monitor__left-tab--active' : '')
                                }
                                onClick={() => setLeftTab('history')}
                            >
                                Xem l·∫°i l·ªô tr√¨nh
                            </button>
                        </div>

                        {leftTab === 'monitor' && (
                            <div className="iky-monitor__left-body">
                                <div className="iky-monitor__left-section">
                                    <div className="iky-monitor__left-label">Nh·∫≠p xe c·∫ßn t√¨m</div>
                                    <input
                                        className="iky-monitor__input"
                                        placeholder="Bi·ªÉn s·ªë / t√™n xe / IMEI..."
                                        value={searchText}
                                        onChange={(e) => setSearchText(e.target.value)}
                                    />
                                </div>

                                <div className="iky-monitor__left-section">
                                    <div className="iky-monitor__left-label">Tr·∫°ng th√°i</div>
                                    <select
                                        className="iky-monitor__select"
                                        value={statusFilter}
                                        onChange={(e) => setStatusFilter(e.target.value)}
                                    >
                                        <option value="all">-- T·∫•t c·∫£ --</option>
                                        <option value="online">Online</option>
                                        <option value="offline">Offline</option>
                                    </select>
                                </div>

                                <div className="iky-monitor__left-section">
                                    <div className="iky-monitor__left-label">Danh s√°ch xe</div>

                                    <div className="iky-monitor__device-list">
                                        {loadingDevices && <div className="iky-loading">ƒêang t·∫£i...</div>}

                                        {!loadingDevices && filteredDevices.length === 0 && (
                                            <div className="iky-monitor__empty">Kh√¥ng c√≥ xe ph√π h·ª£p</div>
                                        )}

                                        {!loadingDevices &&
                                            filteredDevices.map((d) => {
                                                const isOnline = d.status === 10;
                                                const isActive = selectedDevice?._id === d._id;
                                                return (
                                                    <div
                                                        key={d._id}
                                                        className={
                                                            'iky-monitor__device-item' +
                                                            (isActive ? ' iky-monitor__device-item--active' : '')
                                                        }
                                                        onClick={() => handleSelectDevice(d)}
                                                    >
                                                        <div className="plate">
                                                            {d.license_plate || 'Kh√¥ng r√µ bi·ªÉn s·ªë'}
                                                        </div>
                                                        <div className="imei">IMEI: {d.imei}</div>
                                                        <div className="phone">SƒêT: {d.phone_number}</div>
                                                        <div className="status">
                                                            Tr·∫°ng th√°i:{' '}
                                                            <span className={isOnline ? 'online' : 'offline'}>
                                                                {isOnline ? 'Online' : 'Offline'}
                                                            </span>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                    </div>
                                </div>
                            </div>
                        )}

                        {leftTab === 'history' && (
                            <div className="iky-monitor__left-body">
                                <div className="iky-monitor__left-section">
                                    <div className="iky-monitor__left-label">Ch·ªçn xe</div>
                                    <select
                                        className="iky-monitor__select"
                                        value={historyDeviceId}
                                        onChange={(e) => setHistoryDeviceId(e.target.value)}
                                    >
                                        <option value="">-- Ch·ªçn xe --</option>
                                        {deviceList.map((d) => (
                                            <option key={d._id} value={d._id}>
                                                {(d.license_plate || d.imei || 'Kh√¥ng r√µ').trim()}
                                                {d.phone_number ? ` - ${d.phone_number}` : ''}
                                            </option>
                                        ))}
                                    </select>
                                </div>

                                <div className="iky-monitor__left-section">
                                    <div className="iky-monitor__left-label">T·ª´ ng√†y</div>
                                    <input
                                        type="datetime-local"
                                        className="iky-monitor__input"
                                        value={historyStart}
                                        onChange={(e) => setHistoryStart(e.target.value)}
                                    />
                                </div>

                                <div className="iky-monitor__left-section">
                                    <div className="iky-monitor__left-label">ƒê·∫øn ng√†y</div>
                                    <input
                                        type="datetime-local"
                                        className="iky-monitor__input"
                                        value={historyEnd}
                                        onChange={(e) => setHistoryEnd(e.target.value)}
                                    />
                                </div>

                                <button className="iky-monitor__primary-btn" onClick={handleSaveHistoryFilter}>
                                    L∆∞u b·ªô l·ªçc l·ªô tr√¨nh
                                </button>

                                {historyMessage && (
                                    <div
                                        className={
                                            'iky-monitor__alert ' +
                                            (historyMessageType === 'error'
                                                ? 'iky-monitor__alert--error'
                                                : 'iky-monitor__alert--success')
                                        }
                                    >
                                        {historyMessage}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </aside>

                <section className="iky-monitor__center">
                    <div className="iky-monitor__map">
                        <div id="iky-map" className="iky-monitor__map-inner" />

                        {markerScreenPos && showPopup && (
                            <div
                                className="iky-monitor__popup-wrapper"
                                style={{ left: markerScreenPos.x, top: markerScreenPos.y }}
                            >
                                <div className="iky-monitor__popup">
                                    <div className="iky-monitor__popup-tabs">
                                        <button
                                            className={
                                                'iky-monitor__popup-tab' +
                                                (detailTab === 'status' ? ' iky-monitor__popup-tab--active' : '')
                                            }
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                setDetailTab('status');
                                            }}
                                        >
                                            Tr·∫°ng th√°i
                                        </button>
                                        <button
                                            className={
                                                'iky-monitor__popup-tab' +
                                                (detailTab === 'control' ? ' iky-monitor__popup-tab--active' : '')
                                            }
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                setDetailTab('control');
                                            }}
                                        >
                                            ƒêi·ªÅu khi·ªÉn
                                        </button>
                                        <button
                                            className={
                                                'iky-monitor__popup-tab' +
                                                (detailTab === 'battery' ? ' iky-monitor__popup-tab--active' : '')
                                            }
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                setDetailTab('battery');
                                            }}
                                        >
                                            Tr·∫°ng th√°i Pin
                                        </button>
                                    </div>

                                    <div className="iky-monitor__popup-body">
                                        {detailTab === 'status' && (
                                            <div className="iky-monitor__popup-col">{renderStatusInfo()}</div>
                                        )}

                                        {detailTab === 'control' && (
                                            <div className="iky-monitor__popup-col">
                                                <div className="iky-monitor__control-row">
                                                    <span>Tr·∫°ng th√°i k·∫øt n·ªëi</span>
                                                    <div
                                                        className={
                                                            'iky-monitor__connection ' +
                                                            (isConnected
                                                                ? 'iky-monitor__connection--on'
                                                                : 'iky-monitor__connection--off')
                                                        }
                                                    >
                                                        <span className="iky-monitor__connection-icon">‚úì</span>
                                                        <span className="iky-monitor__connection-text">
                                                            {isConnected ? 'K·∫øt n·ªëi' : 'M·∫•t k·∫øt n·ªëi'}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div className="iky-monitor__control-row">
                                                    <span>Tr·∫°ng th√°i thi·∫øt b·ªã</span>

                                                    <div className="iky-status-badge">
                                                        {isLocked ? (
                                                            <LockFilled className="iky-status-icon" />
                                                        ) : (
                                                            <CheckCircleFilled className="iky-status-icon" />
                                                        )}
                                                        <span>{deviceStatusText}</span>
                                                    </div>
                                                </div>

                                                <div className="iky-monitor__control-row">
                                                    <span>Kho√° thi·∫øt b·ªã</span>
                                                    <button
                                                        className="iky-monitor__secondary-btn"
                                                        onClick={handleConfirmLock}
                                                    >
                                                        Kho√°
                                                    </button>
                                                </div>

                                                <div className="iky-monitor__control-row">
                                                    <span>M·ªü kho√° thi·∫øt b·ªã</span>
                                                    <button
                                                        className="iky-monitor__secondary-btn"
                                                        onClick={handleConfirmUnlock}
                                                    >
                                                        M·ªü kho√°
                                                    </button>
                                                </div>

                                                {lockError && (
                                                    <div className="iky-monitor__error" style={{ marginTop: 8 }}>
                                                        {lockError}
                                                    </div>
                                                )}
                                            </div>
                                        )}

                                        {detailTab === 'battery' && (
                                            <div className="iky-monitor__popup-col">{renderBatteryInfo()}</div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </section>

                {showPopup && detailTab === 'battery' && (
                    <aside className="iky-monitor__right">
                        <h4 className="iky-monitor__right-title">Th√¥ng tin hi·ªÉn th·ªã</h4>
                        <div className="iky-monitor__battery-box">{renderBatteryInfo()}</div>
                    </aside>
                )}
            </div>
        </>
    );
};

export default MonitorPage;
